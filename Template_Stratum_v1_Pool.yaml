zabbix_export:
  version: "7.4"

  template_groups:
    - uuid: 4f41362963a542d692ce115de001d8a5
      name: "Templates/Mining"

  templates:
    - uuid: 67670deae3744aaba0d9f3e4508bbf5e
      template: "Template Stratum v1 Pool"
      name: "Template Stratum v1 Pool"
      groups:
        - name: "Templates/Mining"

      macros:
        - macro: "{$STRATUM.PORTS}"
          value: "3333"
          description: "Comma-separated list of Stratum ports to monitor on this host."
        - macro: "{$STRATUM.TIMEOUT}"
          value: "2"
        - macro: "{$STRATUM.EXTRA_ARGS}"
          value: ""
          description: |
            Extra flags string for script --extra.
            Prefer context macros per port, e.g. {$STRATUM.EXTRA_ARGS:"4333"} = --tls --sni pool.example.com
        - macro: "{$STRATUM.USERAGENT}"
          value: "cpuminer"
          description: |
            Value sent as mining.subscribe client/user agent.
            Prefer context macros per port if needed, e.g. {$STRATUM.USERAGENT:"4333"} = cpuminer

        - macro: "{$STRATUM.LATENCY.WARN_MS}"
          value: "1500"
        - macro: "{$STRATUM.LATENCY.HIGH_MS}"
          value: "3000"
        - macro: "{$STRATUM.NODATA}"
          value: "5m"

      discovery_rules:
        - uuid: 2a5bb7a0343d41fca65d4c1aa305b653
          name: "Discover Stratum ports"
          type: EXTERNAL
          key: 'stratum_ports_discovery.py[{$STRATUM.PORTS}]'
          delay: 1h
          lifetime: 7d
          description: "Discovers Stratum ports from {$STRATUM.PORTS} macro and creates per-port items/triggers/graphs."

          item_prototypes:
            - uuid: cd77a24765c74dc4bdea9b8e9771939c
              name: 'Stratum alive (port {#STRATUM.PORT})'
              type: EXTERNAL
              key: 'stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},alive,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}]'
              delay: 30s
              value_type: UNSIGNED
              description: "1 if mining.subscribe succeeds, else 0"

            - uuid: 227ea64f324248839432e2c5d02066e5
              name: 'Stratum latency (ms) (port {#STRATUM.PORT})'
              type: EXTERNAL
              key: 'stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},latency_ms,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}]'
              delay: 30s
              units: ms
              value_type: UNSIGNED

            - uuid: 197b3032da25479abf95dc3478341117
              name: 'Stratum subscribe ok (port {#STRATUM.PORT})'
              type: EXTERNAL
              key: 'stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},subscribe_ok,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}]'
              delay: 1m
              value_type: UNSIGNED

            - uuid: 73d6649c861d4cde93854bc656a7ea7e
              name: 'Stratum notify seen (port {#STRATUM.PORT})'
              type: EXTERNAL
              key: 'stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},notify_seen,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}]'
              delay: 1m
              value_type: UNSIGNED
              description: "Collected for visibility/debugging only (no trigger)."

            - uuid: 9171e16b951e4cb5bfdf823dc69ad47f
              name: 'Stratum extranonce2 size (port {#STRATUM.PORT})'
              type: EXTERNAL
              key: 'stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},extranonce2_size,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}]'
              delay: 5m
              value_type: UNSIGNED

          trigger_prototypes:
            - uuid: fd236afd0a0a49c7af0f132c61e1d80f
              name: 'Stratum is down (>30s) (port {#STRATUM.PORT})'
              expression: 'max(/Template Stratum v1 Pool/stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},alive,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}],30s)=0'
              priority: HIGH

            - uuid: c6241951b01a438f95fe4f5ebbef4c81
              name: 'No Stratum data (port {#STRATUM.PORT})'
              expression: 'nodata(/Template Stratum v1 Pool/stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},alive,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}],{$STRATUM.NODATA})=1'
              priority: AVERAGE

            - uuid: 90d649043ec04172b726d93dfa5f04c3
              name: 'Stratum subscribe failed (port {#STRATUM.PORT})'
              expression: 'min(/Template Stratum v1 Pool/stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},subscribe_ok,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}],5m)=0'
              priority: HIGH

            - uuid: f0ae02e6e0244a94b8e9a8371c8d8a76
              name: 'Stratum latency is high (port {#STRATUM.PORT})'
              expression: 'min(/Template Stratum v1 Pool/stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},latency_ms,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}],5m)>{$STRATUM.LATENCY.HIGH_MS}'
              priority: WARNING

            - uuid: e42e087cf0894ded997a61d2b12e9c18
              name: 'Stratum latency is elevated (port {#STRATUM.PORT})'
              expression: 'min(/Template Stratum v1 Pool/stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},latency_ms,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}],5m)>{$STRATUM.LATENCY.WARN_MS}'
              priority: INFO

          graph_prototypes:
            - uuid: 3346580da1ef4e3489044f9be902d05d
              name: 'Stratum status + latency (port {#STRATUM.PORT})'
              graph_items:
                - color: 00AA00
                  item:
                    host: "Template Stratum v1 Pool"
                    key: 'stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},alive,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}]'
                - color: FF9900
                  item:
                    host: "Template Stratum v1 Pool"
                    key: 'stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},subscribe_ok,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}]'
                - color: 0066FF
                  yaxisside: RIGHT
                  item:
                    host: "Template Stratum v1 Pool"
                    key: 'stratum_v1.py[{HOST.CONN},{#STRATUM.PORT},latency_ms,--timeout,{$STRATUM.TIMEOUT},--useragent,{$STRATUM.USERAGENT:"{#STRATUM.PORT}"} ,--extra,{$STRATUM.EXTRA_ARGS:"{#STRATUM.PORT}"}]'
